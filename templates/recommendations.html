{% extends 'base.html' %}
{% block title %}AI Recommendations - Mini Project{% endblock %}

{% block content %}
<style>
  /* Modern Design System */
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --card-shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .recommendations-hero {
    background: var(--primary-gradient);
    color: white;
    padding: 60px 0 40px;
    margin-bottom: 40px;
    border-radius: 0 0 30px 30px;
    box-shadow: var(--card-shadow);
  }

  .recommendations-hero h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
  }

  .recommendations-hero p {
    font-size: 1.2rem;
    opacity: 0.95;
  }

  /* Enhanced Card Styles */
  .recommendation-card {
    background: white;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    overflow: hidden;
    margin-bottom: 30px;
    border: none;
  }

  .recommendation-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
  }

  .recommendation-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 25px;
    border-radius: 20px 20px 0 0;
  }

  .recommendation-card .card-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .recommendation-card .card-header p {
    margin: 5px 0 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  /* Form Styles */
  .modern-form {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
  }

  .modern-form .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .modern-form .form-control,
  .modern-form .form-select {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 12px 15px;
    transition: var(--transition);
    font-size: 0.95rem;
  }

  .modern-form .form-control:focus,
  .modern-form .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
  }

  /* Button Styles */
  .btn-gradient {
    background: var(--primary-gradient);
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
  }

  .btn-gradient-success {
    background: var(--success-gradient);
    box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
  }

  .btn-gradient-success:hover {
    box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
  }

  /* Restaurant Card Styles */
  .restaurant-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    height: 100%;
    border: none;
  }

  .restaurant-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .restaurant-card .card-img-top {
    height: 220px;
    object-fit: cover;
    transition: var(--transition);
  }

  .restaurant-card:hover .card-img-top {
    transform: scale(1.05);
  }

  .restaurant-card .card-body {
    padding: 20px;
  }

  .restaurant-card .card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
  }

  .restaurant-card .badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-cuisine {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .badge-rating {
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
  }

  .badge-price {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
  }

  /* Trip Plan Styles */
  .trip-day-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    border-left: 5px solid #667eea;
  }

  .trip-day-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .trip-day-header h5 {
    margin: 0;
    font-weight: 600;
  }

  .activity-item {
    background: #f8f9fd;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #667eea;
    transition: var(--transition);
  }

  .activity-item:hover {
    background: #eef1ff;
    transform: translateX(5px);
  }

  .activity-item h6 {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 8px;
  }

  /* Image Gallery */
  .image-gallery {
    position: relative;
    overflow: hidden;
    border-radius: 15px;
    margin-bottom: 20px;
  }

  .image-gallery img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    transition: var(--transition);
  }

  .image-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    color: white;
    padding: 20px;
  }

  /* Loading Animation */
  .loading-container {
    text-align: center;
    padding: 60px 0;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Info Cards */
  .info-highlight {
    background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
    border-radius: 12px;
    padding: 15px 20px;
    margin: 15px 0;
    border-left: 4px solid #667eea;
  }

  .info-highlight strong {
    color: #4a148c;
  }

  /* Cost Breakdown */
  .cost-card {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .cost-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  }

  .cost-total {
    font-size: 1.5rem;
    font-weight: 700;
    color: #d84315;
    padding-top: 15px;
    margin-top: 10px;
    border-top: 2px solid rgba(0, 0, 0, 0.1);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .recommendations-hero h1 {
      font-size: 1.8rem;
    }

    .restaurant-card .card-img-top {
      height: 180px;
    }

    .trip-day-header {
      flex-direction: column;
      text-align: center;
    }
  }

  /* Filter Tags */
  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 15px 0;
  }

  .filter-tag {
    padding: 8px 16px;
    border-radius: 20px;
    background: white;
    border: 2px solid #667eea;
    color: #667eea;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.9rem;
    font-weight: 500;
  }

  .filter-tag:hover {
    background: #667eea;
    color: white;
  }

  .filter-tag.active {
    background: #667eea;
    color: white;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
  }

  /* Insider Tips */
  .insider-tip {
    background: #fff9c4;
    border-left: 4px solid #fbc02d;
    padding: 12px 15px;
    border-radius: 8px;
    margin: 10px 0;
  }

  .insider-tip i {
    color: #f57f17;
    margin-right: 8px;
  }
</style>

<!-- Hero Section -->
<div class="recommendations-hero">
  <div class="container">
    <div class="text-center">
      <h1><i class="fas fa-magic"></i> AI-Powered Travel Recommendations</h1>
      <p>Discover personalized destinations, restaurants, and itineraries with advanced AI</p>
    </div>
  </div>
</div>

<div class="container">
  <!-- Restaurant Recommendations Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="recommendation-card">
        <div class="card-header">
          <h3><i class="fas fa-utensils"></i> Restaurant Finder</h3>
          <p>Get AI-curated restaurant recommendations tailored to your taste</p>
        </div>
        <div class="card-body">
          <form id="restaurantForm" class="modern-form">
            <div class="row">
              <div class="col-md-5 mb-3">
                <label for="restaurantLocation" class="form-label">
                  <i class="fas fa-map-marker-alt"></i> Location
                </label>
                <div class="input-group">
                  <input type="text" class="form-control" id="restaurantLocation" 
                         placeholder="e.g., Paris, Tokyo, Mumbai" required>
                  <button type="button" class="btn btn-outline-primary" id="nearMeBtn">
                    <i class="fas fa-location-arrow"></i> Near Me
                  </button>
                </div>
              </div>
              <div class="col-md-2 mb-3">
                <label for="restaurantBudget" class="form-label">
                  <i class="fas fa-wallet"></i> Budget
                </label>
                <select class="form-select" id="restaurantBudget">
                  <option value="budget">Budget ($)</option>
                  <option value="mid-range" selected>Mid ($$)</option>
                  <option value="luxury">Luxury ($$$)</option>
                </select>
              </div>
              <div class="col-md-2 mb-3">
                <label for="groupSize" class="form-label">
                  <i class="fas fa-users"></i> Group
                </label>
                <input type="number" class="form-control" id="groupSize" value="2" min="1" max="20">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-gradient w-100">
                  <i class="fas fa-search"></i> Find Restaurants
                </button>
              </div>
            </div>

            <!-- Distance Filter -->
            <div class="row mb-2" id="distanceFilterRow" style="display: none;">
              <div class="col-md-6 mb-3">
                <label for="maxDistance" class="form-label">
                  <i class="fas fa-map-marked-alt"></i> Maximum Distance: <span id="distanceValue">10</span> km
                </label>
                <input type="range" class="form-range" id="maxDistance" min="1" max="50" value="10" step="1">
                <small class="text-muted">
                  <i class="fas fa-info-circle"></i> AI will prioritize restaurants within this radius based on your location
                </small>
              </div>
            </div>

            <!-- Advanced Filters -->
            <div class="row mt-2">
              <div class="col-md-6 mb-3">
                <label class="form-label"><i class="fas fa-utensils"></i> Cuisine Preferences</label>
                <div class="filter-tags" id="cuisineFilters">
                  <span class="filter-tag" data-cuisine="Italian">üçù Italian</span>
                  <span class="filter-tag" data-cuisine="Japanese">üç± Japanese</span>
                  <span class="filter-tag" data-cuisine="Indian">üçõ Indian</span>
                  <span class="filter-tag" data-cuisine="Mexican">üåÆ Mexican</span>
                  <span class="filter-tag" data-cuisine="Chinese">ü•° Chinese</span>
                  <span class="filter-tag" data-cuisine="French">ü•ê French</span>
                  <span class="filter-tag" data-cuisine="Thai">üçú Thai</span>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label"><i class="fas fa-clock"></i> Meal Type</label>
                <div class="filter-tags" id="mealTypeFilters">
                  <span class="filter-tag" data-meal="breakfast">üåÖ Breakfast</span>
                  <span class="filter-tag" data-meal="lunch">‚òÄÔ∏è Lunch</span>
                  <span class="filter-tag" data-meal="dinner">üåô Dinner</span>
                  <span class="filter-tag" data-meal="all-day">üïê All Day</span>
                </div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <label class="form-label"><i class="fas fa-fire"></i> Show Me</label>
                <div class="filter-tags" id="popularityFilters">
                  <span class="filter-tag active" data-popularity="all">üçΩÔ∏è All Restaurants</span>
                  <span class="filter-tag" data-popularity="popular">‚≠ê Popular Places</span>
                  <span class="filter-tag" data-popularity="trending">üî• Trending Spots</span>
                </div>
              </div>
            </div>
          </form>

          <div id="restaurantResults" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4><i class="fas fa-star"></i> Top Recommendations</h4>
              <span class="badge bg-primary" id="resultCount">0 results</span>
            </div>
            <div id="restaurantList" class="row">
              <!-- Restaurant recommendations will be populated here -->
            </div>
          </div>

          <div id="restaurantLoading" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <h5>Finding the perfect restaurants for you...</h5>
            <p class="text-muted">Our AI is analyzing hundreds of options</p>
          </div>

          <div id="restaurantError" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-circle"></i>
            <span id="restaurantErrorMessage"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trip Planning Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="recommendation-card">
        <div class="card-header">
          <h3><i class="fas fa-route"></i> Smart Trip Planner</h3>
          <p>Let AI design your perfect itinerary with personalized recommendations</p>
        </div>
        <div class="card-body">
          <form id="tripPlanForm" class="modern-form">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="tripDestination" class="form-label">
                  <i class="fas fa-globe-asia"></i> Destination
                </label>
                <input type="text" class="form-control" id="tripDestination" 
                       placeholder="e.g., Bali, Paris, Kerala" required>
              </div>
              <div class="col-md-2 mb-3">
                <label for="tripDuration" class="form-label">
                  <i class="fas fa-calendar-alt"></i> Days
                </label>
                <input type="number" class="form-control" id="tripDuration" value="3" min="1" max="30" required>
              </div>
              <div class="col-md-2 mb-3">
                <label for="tripBudget" class="form-label">
                  <i class="fas fa-coins"></i> Budget
                </label>
                <select class="form-select" id="tripBudget">
                  <option value="budget">Budget</option>
                  <option value="mid-range" selected>Mid-Range</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
              <div class="col-md-2 mb-3">
                <label for="tripTravelers" class="form-label">
                  <i class="fas fa-user-friends"></i> Travelers
                </label>
                <input type="number" class="form-control" id="tripTravelers" value="1" min="1" max="20">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-gradient-success w-100">
                  <i class="fas fa-magic"></i> Generate Plan
                </button>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="userHomeCity" class="form-label">
                  <i class="fas fa-home"></i> Your Home City (Optional)
                </label>
                <input type="text" class="form-control" id="userHomeCity" 
                       placeholder="e.g., Mumbai, New York">
                <small class="text-muted">For accurate distance & transport costs</small>
              </div>
              <div class="col-md-4 mb-3">
                <label for="userHomeCountry" class="form-label">
                  <i class="fas fa-flag"></i> Your Home Country (Optional)
                </label>
                <input type="text" class="form-control" id="userHomeCountry" 
                       placeholder="e.g., India, USA">
                <small class="text-muted">For visa requirements & currency</small>
              </div>
              <div class="col-md-4 mb-3">
                <label for="tripInterests" class="form-label">
                  <i class="fas fa-heart"></i> Interests (Optional)
                </label>
                <input type="text" class="form-control" id="tripInterests" 
                       placeholder="e.g., culture, food, adventure">
                <small class="text-muted">Comma-separated values</small>
              </div>
            </div>
          </form>

          <div id="tripPlanResults" style="display: none;">
            <div id="tripPlanContent">
              <!-- Trip plan content will be populated here -->
            </div>
          </div>

          <div id="tripPlanLoading" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <h5>Creating your personalized trip plan...</h5>
            <p class="text-muted">This may take a moment as our AI crafts the perfect itinerary</p>
          </div>

          <div id="tripPlanError" class="alert alert-danger d-none">
            <i class="fas fa-exclamation-circle"></i>
            <span id="tripPlanErrorMessage"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Transport Display Module -->
<script src="{{ url_for('static', filename='transport-display.js') }}"></script>

<!-- Include Directions Module -->
<script src="{{ url_for('static', filename='directions.js') }}"></script>

<!-- Route Display Modal -->
<div id="routeModal" class="route-modal">
  <div class="route-modal-content">
    <div class="route-modal-header">
      <h3 id="routeModalTitle"><i class="fas fa-route"></i> Route Details</h3>
      <button class="route-modal-close" onclick="closeRouteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="route-modal-body">
      <div id="routeLoading" class="route-loading">
        <div class="loading-spinner"></div>
        <p>Loading route...</p>
      </div>
      <div id="routeError" class="route-error" style="display: none;"></div>
      <div id="routeInfo" class="route-info"></div>
      <div id="routeMapContainer" class="route-map-container"></div>
    </div>
  </div>
</div>

<style>
/* Route Modal Styles */
.route-modal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
}

.route-modal-content {
  background: white;
  margin: 2% auto;
  padding: 0;
  border-radius: 20px;
  width: 90%;
  max-width: 1000px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.route-modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.route-modal-header h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
}

.route-modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.route-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.route-modal-body {
  padding: 20px 30px 30px;
  overflow-y: auto;
  flex: 1;
}

.route-loading {
  text-align: center;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.route-error {
  background: #fee;
  color: #c33;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
  border-left: 4px solid #c33;
}

.route-info {
  margin-bottom: 20px;
}

.route-info-card {
  display: flex;
  gap: 20px;
  background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.route-stat {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 15px;
}

.route-stat i {
  font-size: 2rem;
  color: #00838f;
}

.route-stat > div {
  display: flex;
  flex-direction: column;
}

.route-label {
  font-size: 0.85rem;
  color: #00838f;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.route-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #004d40;
}

.route-map-container {
  height: 450px;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Direction Button Styles */
.btn-directions {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  margin-top: 10px;
}

.btn-directions:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-directions i {
  font-size: 1rem;
}

.btn-route {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.btn-route:hover {
  box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .route-modal-content {
    width: 95%;
    margin: 5% auto;
    max-height: 85vh;
  }

  .route-modal-header {
    padding: 15px 20px;
  }

  .route-modal-header h3 {
    font-size: 1.2rem;
  }

  .route-modal-body {
    padding: 15px 20px 20px;
  }

  .route-info-card {
    flex-direction: column;
    gap: 15px;
  }

  .route-map-container {
    height: 300px;
  }

  .btn-directions {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script>
// Filter state variables
let selectedCuisines = [];
let selectedMealTypes = [];
let selectedPopularity = 'all';
let userCurrentLocation = null;

// Cuisine filter handling
document.querySelectorAll('#cuisineFilters .filter-tag').forEach(tag => {
  tag.addEventListener('click', function() {
    this.classList.toggle('active');
    const cuisine = this.dataset.cuisine;
    if (selectedCuisines.includes(cuisine)) {
      selectedCuisines = selectedCuisines.filter(c => c !== cuisine);
    } else {
      selectedCuisines.push(cuisine);
    }
  });
});

// Meal type filter handling
document.querySelectorAll('#mealTypeFilters .filter-tag').forEach(tag => {
  tag.addEventListener('click', function() {
    this.classList.toggle('active');
    const meal = this.dataset.meal;
    if (selectedMealTypes.includes(meal)) {
      selectedMealTypes = selectedMealTypes.filter(m => m !== meal);
    } else {
      selectedMealTypes.push(meal);
    }
  });
});

// Popularity filter handling (single selection)
document.querySelectorAll('#popularityFilters .filter-tag').forEach(tag => {
  tag.addEventListener('click', function() {
    // Remove active from all
    document.querySelectorAll('#popularityFilters .filter-tag').forEach(t => t.classList.remove('active'));
    // Add active to clicked
    this.classList.add('active');
    selectedPopularity = this.dataset.popularity;
  });
});

// Distance slider handling
document.getElementById('maxDistance').addEventListener('input', function() {
  document.getElementById('distanceValue').textContent = this.value;
});

// Near Me button handling
document.getElementById('nearMeBtn').addEventListener('click', async function() {
  const btn = this;
  const originalHtml = btn.innerHTML;
  
  // Show loading state
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
  btn.disabled = true;
  
  try {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
      return;
    }
    
    // Get current position
    navigator.geolocation.getCurrentPosition(
      async function(position) {
        userCurrentLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };
        
        // Reverse geocode to get location name
        try {
          const response = await fetch(`/api/reverse-geocode?lat=${userCurrentLocation.lat}&lon=${userCurrentLocation.lon}`);
          if (response.ok) {
            const data = await response.json();
            document.getElementById('restaurantLocation').value = data.city || data.label || `${userCurrentLocation.lat.toFixed(4)}, ${userCurrentLocation.lon.toFixed(4)}`;
            
            // Show distance filter
            document.getElementById('distanceFilterRow').style.display = 'flex';
            
            btn.innerHTML = '<i class="fas fa-check"></i> Location Set';
            setTimeout(() => {
              btn.innerHTML = originalHtml;
              btn.disabled = false;
            }, 2000);
          } else {
            throw new Error('Could not reverse geocode');
          }
        } catch (error) {
          // Fallback to coordinates
          document.getElementById('restaurantLocation').value = `${userCurrentLocation.lat.toFixed(4)}, ${userCurrentLocation.lon.toFixed(4)}`;
          document.getElementById('distanceFilterRow').style.display = 'flex';
          btn.innerHTML = originalHtml;
          btn.disabled = false;
        }
      },
      function(error) {
        console.error('Geolocation error:', error);
        alert('Could not get your location. Please enter it manually or enable location permissions.');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  } catch (error) {
    console.error('Error getting location:', error);
    alert('An error occurred while getting your location.');
    btn.innerHTML = originalHtml;
    btn.disabled = false;
  }
});

// Restaurant Recommendations
document.getElementById('restaurantForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const location = document.getElementById('restaurantLocation').value;
  const budget = document.getElementById('restaurantBudget').value;
  const groupSize = document.getElementById('groupSize').value;
  const cuisine = selectedCuisines.join(',');
  const mealType = selectedMealTypes.join(',');
  const maxDistance = document.getElementById('maxDistance').value;

  // Show loading
  document.getElementById('restaurantLoading').style.display = 'block';
  document.getElementById('restaurantResults').style.display = 'none';
  document.getElementById('restaurantError').classList.add('d-none');

  try {
    // Build URL with all parameters
    let url = `/api/restaurant-recommendations?location=${encodeURIComponent(location)}&budget=${budget}&group_size=${groupSize}`;
    
    if (cuisine) {
      url += `&cuisine=${encodeURIComponent(cuisine)}`;
    }
    
    // Add meal type filter
    if (mealType) {
      url += `&meal_type=${encodeURIComponent(mealType)}`;
    }
    
    // Add popularity filter
    if (selectedPopularity !== 'all') {
      url += `&popularity=${selectedPopularity}`;
    }
    
    // Add user location and distance filter if available
    if (userCurrentLocation) {
      url += `&user_lat=${userCurrentLocation.lat}&user_lon=${userCurrentLocation.lon}`;
      url += `&max_distance_km=${maxDistance}`;
    }
    
    const response = await fetch(url);
    const data = await response.json();

    if (response.ok) {
      displayRestaurantRecommendations(data);
    } else {
      showRestaurantError(data.error || 'Failed to get recommendations');
    }
  } catch (error) {
    showRestaurantError('Network error. Please try again.');
  }

  document.getElementById('restaurantLoading').style.display = 'none';
});

function displayRestaurantRecommendations(data) {
  const container = document.getElementById('restaurantList');
  container.innerHTML = '';

  if (data.recommendations && data.recommendations.length > 0) {
    document.getElementById('resultCount').textContent = `${data.recommendations.length} results`;
    
    data.recommendations.forEach(restaurant => {
      const rating = restaurant.rating || 'N/A';
      const cuisine = restaurant.cuisine || 'International';
      const price = restaurant.price_range || '$$';
      const description = restaurant.detailed_description || restaurant.description || '';
      const whyPerfect = restaurant.why_perfect_for_you || restaurant.recommendation_reason || '';
      
      // Build insider tips
      let tipsHtml = '';
      if (restaurant.insider_tips && Array.isArray(restaurant.insider_tips) && restaurant.insider_tips.length > 0) {
        tipsHtml = restaurant.insider_tips.map(tip => 
          `<div class="insider-tip"><i class="fas fa-lightbulb"></i> ${tip}</div>`
        ).join('');
      }
      
      // Build signature dishes
      let dishesHtml = '';
      if (restaurant.signature_dishes && Array.isArray(restaurant.signature_dishes)) {
        dishesHtml = '<div class="mt-3"><strong><i class="fas fa-star"></i> Must-Try Dishes:</strong><div class="mt-2">';
        restaurant.signature_dishes.forEach(dish => {
          if (typeof dish === 'string') {
            dishesHtml += `<span class="badge badge-cuisine me-2 mb-2">${dish}</span>`;
          } else if (typeof dish === 'object' && dish.name) {
            dishesHtml += `<div class="mb-2"><strong>${dish.name}</strong>`;
            if (dish.description) {
              dishesHtml += ` - <small>${dish.description}</small>`;
            }
            dishesHtml += `</div>`;
          }
        });
        dishesHtml += '</div></div>';
      }
      
      const restaurantCard = `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="restaurant-card">
            ${restaurant.image_url ? `
              <img src="${restaurant.image_url}" class="card-img-top" alt="${restaurant.name}">
            ` : `
              <div class="card-img-top bg-gradient" style="height: 220px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-utensils" style="font-size: 4rem; color: white; opacity: 0.3;"></i>
              </div>
            `}
            <div class="card-body">
              <h5 class="card-title">${restaurant.name}</h5>
              <div class="mb-3">
                <span class="badge badge-cuisine me-1">${cuisine}</span>
                <span class="badge badge-rating me-1">‚≠ê ${rating}</span>
                <span class="badge badge-price">${price}</span>
              </div>
              ${description ? `<p class="card-text text-muted">${description}</p>` : ''}
              ${whyPerfect ? `
                <div class="info-highlight">
                  <strong><i class="fas fa-heart"></i> Perfect for you:</strong><br>
                  <small>${whyPerfect}</small>
                </div>
              ` : ''}
              ${restaurant.address ? `
                <p class="mt-2 mb-1"><small><i class="fas fa-map-marker-alt"></i> ${restaurant.address}</small></p>
              ` : ''}
              ${restaurant.best_time ? `
                <p class="mb-1"><small><i class="fas fa-clock"></i> Best time: ${restaurant.best_time}</small></p>
              ` : ''}
              ${dishesHtml}
              ${tipsHtml}
              <button class="btn btn-directions" onclick="openGoogleMapsDirections('${restaurant.address || restaurant.name}', '${restaurant.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-directions"></i>
                Get Directions
              </button>
            </div>
          </div>
        </div>
      `;
      container.innerHTML += restaurantCard;
    });
  } else {
    container.innerHTML = `
      <div class="col-12">
        <div class="empty-state">
          <i class="fas fa-search"></i>
          <h5>No restaurants found</h5>
          <p>Try adjusting your filters or search in a different location</p>
        </div>
      </div>
    `;
  }

  document.getElementById('restaurantResults').style.display = 'block';
}

function showRestaurantError(message) {
  document.getElementById('restaurantErrorMessage').textContent = message;
  document.getElementById('restaurantError').classList.remove('d-none');
}

// Load user's saved location on page load
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const response = await fetch('/api/me');
    if (response.ok) {
      const userData = await response.json();
      if (userData.authenticated) {
        // Pre-fill location fields if user has saved location
        if (userData.home_city) {
          document.getElementById('userHomeCity').value = userData.home_city;
        }
        if (userData.home_country) {
          document.getElementById('userHomeCountry').value = userData.home_country;
        }
      }
    }
  } catch (error) {
    console.log('Could not load user data:', error);
  }
});

// Trip Planning
document.getElementById('tripPlanForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const destination = document.getElementById('tripDestination').value;
  const duration = document.getElementById('tripDuration').value;
  const budget = document.getElementById('tripBudget').value;
  const travelers = document.getElementById('tripTravelers').value;
  const interests = document.getElementById('tripInterests').value;
  const userHomeCity = document.getElementById('userHomeCity').value.trim();
  const userHomeCountry = document.getElementById('userHomeCountry').value.trim();

  // Show loading
  document.getElementById('tripPlanLoading').style.display = 'block';
  document.getElementById('tripPlanResults').style.display = 'none';
  document.getElementById('tripPlanError').classList.add('d-none');

  try {
    const requestBody = {
      destination: destination,
      duration_days: parseInt(duration),
      budget: budget,
      travelers: parseInt(travelers),
      interests: interests ? interests.split(',').map(i => i.trim()) : []
    };

    // Add location data if provided
    if (userHomeCity) {
      requestBody.user_home_city = userHomeCity;
    }
    if (userHomeCountry) {
      requestBody.user_home_country = userHomeCountry;
    }

    const response = await fetch('/api/trip-plan', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody)
    });

    const data = await response.json();

    if (response.ok) {
      displayTripPlan(data);
    } else {
      showTripPlanError(data.error || 'Failed to generate trip plan');
    }
  } catch (error) {
    showTripPlanError('Network error. Please try again.');
  }

  document.getElementById('tripPlanLoading').style.display = 'none';
});

function displayTripPlan(data) {
  const container = document.getElementById('tripPlanContent');

  if (data.error) {
    container.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
  } else {
    let html = `
      <div class="mb-4">
        <h3><i class="fas fa-map-marked-alt"></i> ${data.destination} - ${data.duration_days} Day Adventure</h3>
        <p class="text-muted"><i class="fas fa-coins"></i> ${data.budget_category} Budget ‚Ä¢ <i class="fas fa-users"></i> ${data.travelers} Traveler(s)</p>
      </div>
    `;

    // Display destination image
    if (data.destination_image) {
      html += `
        <div class="image-gallery">
          <img src="${data.destination_image}" alt="${data.destination}">
          <div class="image-overlay">
            <h4>${data.destination}</h4>
            ${data.destination_overview ? `<p>${data.destination_overview.description || ''}</p>` : ''}
          </div>
        </div>
      `;
    }
    
    // Personalization summary
    if (data.personalization_summary) {
      html += `
        <div class="info-highlight">
          <strong><i class="fas fa-magic"></i> Personalized For You:</strong><br>
          ${data.personalization_summary}
        </div>
      `;
    }

    // Itinerary
    if (data.itinerary) {
      data.itinerary.forEach(day => {
        html += `
          <div class="trip-day-card">
            <div class="trip-day-header">
              <h5><i class="fas fa-calendar-day"></i> Day ${day.day}</h5>
              ${day.theme ? `<span class="badge bg-light text-dark">${day.theme}</span>` : ''}
            </div>
            <div class="row">
              <div class="col-12">
                <h6 class="mb-3"><i class="fas fa-list"></i> Activities</h6>
        `;
        
        // Handle activities
        if (day.activities && Array.isArray(day.activities)) {
          day.activities.forEach(activity => {
            if (typeof activity === 'string') {
              html += `<div class="activity-item"><p class="mb-0">${activity}</p></div>`;
            } else if (typeof activity === 'object') {
              html += `
                <div class="activity-item">
                  <h6>${activity.name || 'Activity'}</h6>
                  ${activity.description ? `<p class="mb-2">${activity.description}</p>` : ''}
                  ${activity.duration_hours ? `<small><i class="fas fa-clock"></i> ${activity.duration_hours} hours</small>` : ''}
                </div>
              `;
            }
          });
        }
        
        html += `
              </div>
            </div>
          </div>
        `;
      });
    }

    // Transportation Options Section (NEW!)
    if (data.travel_from_home || data.transportation_details) {
      const transportData = data.travel_from_home || data.transportation_details;
      html += `
        <div class="mt-4">
          <h4 class="mb-3"><i class="fas fa-route"></i> How to Get There</h4>
          <div id="transportOptionsContainer"></div>
        </div>
      `;
    }

    // Estimated costs
    if (data.estimated_costs) {
      html += `
        <div class="cost-card">
          <h5 class="mb-3"><i class="fas fa-rupee-sign"></i> Estimated Costs</h5>
          <div class="cost-item">
            <span>Accommodation</span>
            <span>‚Çπ${data.estimated_costs.accommodation || 0}</span>
          </div>
          <div class="cost-item">
            <span>Food</span>
            <span>‚Çπ${data.estimated_costs.food || 0}</span>
          </div>
          <div class="cost-item">
            <span>Transportation</span>
            <span>‚Çπ${(data.estimated_costs.transportation_local || 0) + (data.estimated_costs.transportation_to_destination || 0)}</span>
          </div>
          <div class="cost-item">
            <span>Activities</span>
            <span>‚Çπ${data.estimated_costs.activities || 0}</span>
          </div>
          <div class="cost-total">
            <span>Total</span>
            <span>‚Çπ${data.estimated_costs.total || 0}</span>
          </div>
        </div>
      `;
    }

    container.innerHTML = html;
    
    // Display transportation options using the transport-display module
    if (data.travel_from_home || data.transportation_details) {
      const transportData = data.travel_from_home || data.transportation_details;
      // Use setTimeout to ensure DOM is ready
      setTimeout(() => {
        if (typeof displayTransportOptions === 'function') {
          // Pass destination coordinates for route viewing
          const destinationInfo = {
            name: data.destination,
            lat: data.destination_latitude || null,
            lon: data.destination_longitude || null
          };
          displayTransportOptions(transportData, 'transportOptionsContainer', destinationInfo);
        }
      }, 100);
    }
  }

  document.getElementById('tripPlanResults').style.display = 'block';
}

function showTripPlanError(message) {
  document.getElementById('tripPlanErrorMessage').textContent = message;
  document.getElementById('tripPlanError').classList.remove('d-none');
}
</script>

{% endblock %}
